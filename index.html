<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Shelter Bible Study Group Assignment</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #2c5282 0%, #2a4365 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      border-bottom: 4px solid #d69e2e;
    }
    .header-with-logo { display:flex; flex-direction:column; align-items:center; gap:10px; }
    .app-logo { max-width:150px; height:auto; }
    .header h1 { font-size: 2.0em; }
    .header p { opacity: 0.95; font-style: italic; }

    .content { padding: 30px; }
    .success-message {
      display:none;
      background:#38a169;
      color:#fff;
      padding:14px 18px;
      border-radius: 10px;
      margin-bottom: 18px;
      font-weight: 600;
      text-align:center;
    }
    .success-message.show { display:block; }

    .input-section h2 {
      color:#2d3748;
      margin-bottom: 18px;
      font-size: 1.4em;
      border-bottom: 3px solid #d69e2e;
      padding-bottom: 8px;
    }
    .form-group { margin-bottom: 16px; }
    .form-group label { display:block; margin-bottom:6px; color:#4a5568; font-weight:600; }
    .form-group input {
      width:100%;
      padding: 12px 14px;
      border: 2px solid #cbd5e0;
      border-radius: 8px;
      font-size: 1em;
      background:#f7fafc;
    }
    .form-group input:focus {
      outline:none;
      border-color:#2c5282;
      box-shadow: 0 0 0 3px rgba(44, 82, 130, 0.1);
      background:#fff;
    }
    .input-hint { font-size:0.85em; color:#718096; margin-top:6px; font-style: italic; }

    .row {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 750px) {
      .row { grid-template-columns: 1fr; }
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 1.05em;
      font-weight: 700;
      cursor:pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    .btn.primary {
      background: linear-gradient(135deg, #2c5282 0%, #2a4365 100%);
      color: white;
    }
    .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(44, 82, 130, 0.35); }
    .btn.secondary {
      background: #fff;
      color: #2c5282;
      border: 2px solid #2c5282;
    }
    .btn.secondary:hover { background:#fbd38d; color:#2d3748; border-color:#fbd38d; }
    .btn.danger {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      color:#fff;
    }
    .btn.danger:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(229,62,62,0.35); }

    .loading-spinner { display:none; text-align:center; padding: 12px; color:#2c5282; }
    .loading-spinner.show { display:block; }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2c5282;
      border-radius: 50%;
      width: 28px; height: 28px;
      animation: spin 1s linear infinite;
      margin: 0 auto 8px;
    }
    @keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }

    .group-display {
      display:none;
      background: linear-gradient(135deg, #2c5282 0%, #2a4365 100%);
      color:#fff;
      padding: 22px;
      border-radius: 12px;
      margin-top: 22px;
      box-shadow: 0 8px 24px rgba(44,82,130,0.28);
    }
    .group-display.show { display:block; }
    .group-display h3 { text-align:center; margin-bottom: 14px; border-bottom: 2px solid #d69e2e; padding-bottom: 12px; }
    .group-info { background: rgba(255,255,255,0.14); padding: 18px; border-radius: 10px; }
    .group-info p { margin-bottom: 10px; line-height: 1.6; }
    .group-info strong { color:#fbd38d; }
    .group-assignment-statement {
      font-size: 1.2em;
      color:#fbd38d;
      font-weight: 800;
      text-align:center;
      margin: 16px 0;
      padding: 14px;
      background: rgba(251,211,141,0.18);
      border-radius: 10px;
      border: 2px solid #fbd38d;
    }
    .meeting-location {
      background: rgba(251, 211, 141, 0.18);
      padding: 14px;
      border-radius: 10px;
      margin-top: 12px;
      border: 2px solid #fbd38d;
    }
    .meeting-location h4 {
      color:#fbd38d;
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom: 8px;
    }

    .members-list { margin-top: 18px; border-top: 2px solid rgba(255,255,255,0.25); padding-top: 14px; }
    .member-item {
      background: rgba(255,255,255,0.2);
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #d69e2e;
    }

    .distance-info {
      margin-top: 14px;
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    #map { height: 480px; width:100%; border-radius: 10px; margin-top: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

    .section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 3px solid #e2e8f0;
    }
    .section h3 { text-align:center; color:#2d3748; margin-bottom: 14px; }

    .all-groups { display:none; }
    .group-card {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      border: 2px solid #cbd5e0;
      border-radius: 10px;
      padding: 18px;
      margin-bottom: 14px;
      transition: all 0.2s;
    }
    .group-card:hover { border-color:#2c5282; box-shadow: 0 6px 20px rgba(44,82,130,0.12); transform: translateY(-1px); }
    .group-card-header { display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #d69e2e; padding-bottom: 10px; margin-bottom: 10px; }
    .group-title { font-size:1.2em; color:#2c5282; font-weight:800; }
    .group-count { background:#2c5282; color:#fff; padding: 6px 14px; border-radius: 22px; font-weight:800; }

    .group-members { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
    .group-member { background:#fff; padding: 10px 12px; border-radius: 6px; border-left: 3px solid #d69e2e; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    .location-info { background:#edf2f7; padding: 10px 12px; border-radius: 8px; margin-top: 10px; color:#4a5568; font-size: 0.95em; }

    .export-section {
      margin-top: 16px;
      padding: 18px;
      background:#f7fafc;
      border-radius:10px;
      border:2px solid #cbd5e0;
      display:none;
    }
    .export-buttons {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .export-btn {
      padding: 14px 16px;
      background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
      color:#fff;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight: 700;
    }
    .export-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(47,133,90,0.35); }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-with-logo">
        <img src="logo.png" alt="The Shelter Logo" class="app-logo" />
        <h1>‚úùÔ∏è The Shelter Bible Study</h1>
        <p>Group Assignment - Illinois Region</p>
      </div>
    </div>

    <div class="content">
      <div class="success-message" id="successMessage">‚úÖ Information Saved Successfully!</div>

      <div class="input-section">
        <h2>üìù Enter Your Information</h2>

        <form id="userForm">
          <div class="row">
            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" required placeholder="Enter your first name" />
            </div>

            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" required placeholder="Enter your last name" />
            </div>
          </div>

          <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="text" id="phone" placeholder="e.g., (555) 123-4567" />
            <div class="input-hint">Please enter phone number for group communication</div>
          </div>

          <div class="form-group">
            <label for="location">Location (Illinois)</label>
            <input type="text" id="location" required placeholder="e.g., 123 Main St, Chicago, IL 60639" />
            <div class="input-hint">Please include your complete Illinois address with ZIP code</div>
          </div>

          <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <p>Geocoding your location...</p>
          </div>

          <div class="row">
            <button type="submit" class="btn primary" id="submitBtn">üôè Submit & Find My Group</button>
            <button type="button" class="btn danger" id="resetBtn">üóëÔ∏è Reset All Data</button>
          </div>
        </form>
      </div>

      <div class="group-display" id="groupDisplay">
        <h3>üéâ Your Assigned Group</h3>

        <div class="group-info">
          <p><strong>Name:</strong> <span id="displayName"></span></p>
          <p><strong>Phone:</strong> <span id="displayPhone"></span></p>
          <p><strong>Location:</strong> <span id="displayLocation"></span></p>
          <p><strong>ZIP Code:</strong> <span id="displayZip"></span></p>

          <div class="group-assignment-statement">
            Your group is '<span id="displayGroup"></span>'
          </div>

          <div id="meetingLocationContainer"></div>

          <div class="members-list">
            <h4 style="color:#fbd38d;">üë• Your Group Members:</h4>
            <div id="membersContainer"></div>

            <div class="distance-info" id="distanceInfo" style="display:none;"></div>

            <button type="button" class="btn secondary" id="addAnotherBtn" style="margin-top: 14px;">
              ‚ûï Add Another Person
            </button>
          </div>
        </div>
      </div>

      <div class="section" id="mapSection" style="display:none;">
        <h3>üó∫Ô∏è Group Locations Map</h3>
        <div id="map"></div>
      </div>

      <div class="section all-groups" id="allGroups">
        <h3>üìä All Bible Study Groups</h3>

        <div class="section" id="adminSection">
          <h3>üîê Admin Dashboard</h3>

          <div class="export-section" style="display:block;">
            <div id="adminLoginBox">
              <p style="color:#4a5568; margin-bottom:10px;">Enter admin password to view registrations.</p>
              <div class="row">
                <input id="adminPassword" type="password" placeholder="Admin password" style="padding:12px;border:2px solid #cbd5e0;border-radius:8px;">
                <button class="export-btn" type="button" id="adminLoginBtn">Login</button>
              </div>
              <p id="adminLoginError" style="color:#c53030; margin-top:10px; display:none;">Wrong password.</p>
            </div>

            <div id="adminDashboard" style="display:none;">
              <div class="row" style="margin-bottom:12px;">
                <button class="export-btn" type="button" id="adminRefreshBtn">üîÑ Refresh</button>
                <button class="export-btn" type="button" id="adminLogoutBtn" style="background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);">üö™ Logout</button>
              </div>

              <div style="overflow:auto; border:2px solid #cbd5e0; border-radius:10px; background:white;">
                <table style="width:100%; border-collapse:collapse; min-width:1000px;">
                  <thead style="background:#edf2f7;">
                    <tr>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Name</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Phone</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">ZIP</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Group</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Group Address</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Location</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Distance (mi)</th>
                      <th style="text-align:left; padding:10px; border-bottom:2px solid #cbd5e0;">Registered</th>
                    </tr>
                  </thead>
                  <tbody id="adminTableBody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="export-section" id="exportSection">
          <h3 style="text-align:left; margin-bottom: 8px;">üíæ Export Group Data</h3>
          <p style="color:#4a5568;">Download group assignments in various formats</p>

          <div class="export-buttons">
            <button class="export-btn" type="button" id="exportCsvBtn">üìÑ Export to CSV</button>
            <button class="export-btn" type="button" id="exportXlsxBtn">üìä Export to Excel</button>
            <button class="export-btn" type="button" id="exportSummaryBtn">üìã Export Summary Report</button>
            <button class="export-btn" type="button" id="exportDistancesBtn">üìè Export with Distances</button>
          </div>
        </div>

        <div id="groupsContainer"></div>
      </div>
    </div>
  </div>

  <script>
    // -----------------------------
    // CONFIG / STORAGE
    // -----------------------------
    const STORAGE_KEY_DATA = "shelterBibleStudyData_v2";
    const ADMIN_PASSWORD = "ChangeMe123!"; // üî¥ change this

    // Meeting centers (your spreadsheet locations)
    const groupLocations = {
      "Sabaoth": {
        addresses: ["497 N Frieh Drive, Romeoville, IL 60446"],
        coordinates: [{ lat: 41.6784, lon: -88.0863 }],
      },
      "Ever Present Help": {
        addresses: ["4352 W Parker Ave, Chicago, IL 60639"],
        coordinates: [{ lat: 41.9486, lon: -87.7384 }]
      },
      "Kaddosh": {
        addresses: ["1336 Greenwillow Lane, Glenview, IL 60025"],
        coordinates: [{ lat: 42.0697, lon: -87.8278 }]
      },
      "unQuestionable God": {
        addresses: ["1816 Grove Ave, Berwyn, IL 60402"],
        coordinates: [{ lat: 41.8506, lon: -87.7937 }]
      },
      "Indescribable God": {
        addresses: ["361 S Cornerstone Dr, Volo, IL 60020"],
        coordinates: [{ lat: 42.3258, lon: -88.1673 }]
      },
      "Unfailing Helper": {
        addresses: ["6127 N Talman Ave, Chicago, IL 60659"],
        coordinates: [{ lat: 41.9942, lon: -87.6931 }]
      },
      "Zion's King": {
        addresses: ["2468 Lambert Dr, Aurora, IL 60639"],
        coordinates: [{ lat: 41.7606, lon: -88.3201 }]
      }
    };

    // -----------------------------
    // STATE
    // -----------------------------
    let allPeople = [];
    let map = null;
    let memberMarkers = [];
    let meetingMarkers = [];

    // -----------------------------
    // COORD + DISTANCE (HARDENED)
    // -----------------------------
    function normalizeCoords(c) {
      if (!c) return null;
      const lat = c.lat ?? c.latitude;
      const lon = c.lon ?? c.lng ?? c.longitude;
      const nLat = Number(lat);
      const nLon = Number(lon);
      if (!Number.isFinite(nLat) || !Number.isFinite(nLon)) return null;
      return { lat: nLat, lon: nLon };
    }

    function haversineMiles(lat1, lon1, lat2, lon2) {
      lat1 = Number(lat1); lon1 = Number(lon1);
      lat2 = Number(lat2); lon2 = Number(lon2);
      if (![lat1, lon1, lat2, lon2].every(Number.isFinite)) return null;

      const R = 3958.8; // miles
      const toRad = (x) => (x * Math.PI) / 180;

      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);

      const a =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) ** 2;

      return 2 * R * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // -----------------------------
    // HELPERS
    // -----------------------------
    function extractILZipCode(location) {
      const match = location.match(/\b(60\d{3})\b/);
      return match ? match[1] : null;
    }

    function normalizePhone(phone) {
      const digits = String(phone ?? "").replace(/\D/g, "");
      if (digits.length === 10) return digits;
      if (digits.length === 11 && digits.startsWith("1")) return digits.slice(1);
      return null;
    }

    function formatPhone(digits) {
      const d = normalizePhone(digits);
      if (!d) return "";
      return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
    }

    async function geocodeAddress(address) {
      try {
        const url = "https://photon.komoot.io/api/?q=" + encodeURIComponent(address) + "&limit=1";
        const res = await fetch(url, { headers: { Accept: "application/json" } });
        const data = await res.json();

        if (data?.features?.length) {
          // Photon returns [lon, lat]
          const [lon, lat] = data.features[0].geometry.coordinates;
          return normalizeCoords({ lat, lon });
        }
        return null;
      } catch (e) {
        console.error("Geocode error:", e);
        return null;
      }
    }

    function findNearestGroup(userCoordinatesRaw) {
      const userCoordinates = normalizeCoords(userCoordinatesRaw);
      if (!userCoordinates) {
        return { groupName: null, address: null, distance: null };
      }

      let nearestGroup = null;
      let nearestAddress = null;
      let minDistance = Infinity;

      for (const groupName in groupLocations) {
        const group = groupLocations[groupName];

        group.coordinates.forEach((coordRaw, idx) => {
          const coord = normalizeCoords(coordRaw);
          if (!coord) return;

          const d = haversineMiles(userCoordinates.lat, userCoordinates.lon, coord.lat, coord.lon);
          if (d === null) return;

          if (d < minDistance) {
            minDistance = d;
            nearestGroup = groupName;
            nearestAddress = group.addresses[idx];
          }
        });
      }

      return {
        groupName: nearestGroup,
        address: nearestAddress,
        distance: Number.isFinite(minDistance) ? minDistance : null
      };
    }

    function showSuccess() {
      const el = document.getElementById("successMessage");
      el.classList.add("show");
      setTimeout(() => el.classList.remove("show"), 2500);
    }

    function save() {
      localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(allPeople));
    }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY_DATA);
      if (!raw) return;
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          // Normalize coords on load (in case older saves were inconsistent)
          allPeople = parsed.map(p => ({
            ...p,
            coordinates: normalizeCoords(p.coordinates)
          }));
        }
      } catch (e) {
        console.warn("Bad storage data:", e);
      }
    }

    // -----------------------------
    // MAP
    // -----------------------------
    function initMap() {
      if (map) return;

      map = L.map("map").setView([41.8781, -87.6298], 8);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
        maxZoom: 18
      }).addTo(map);
    }

    function clearMarkers(list) {
      if (!map) return;
      list.forEach((m) => map.removeLayer(m));
      list.length = 0;
    }

    function addMemberMarker(person) {
      if (!map) return;
      const c = normalizeCoords(person.coordinates);
      if (!c) return;

      const marker = L.circleMarker([c.lat, c.lon], {
        radius: 8,
        fillColor: "#2c5282",
        color: "#fff",
        weight: 2,
        opacity: 1,
        fillOpacity: 0.85
      }).addTo(map);

      marker.bindPopup(
        `<strong>${escapeHtml(person.firstName)} ${escapeHtml(person.lastName)}</strong><br>
         Phone: ${escapeHtml(formatPhone(person.phone))}<br>
         Group: ${escapeHtml(person.group)}<br>
         ZIP: ${escapeHtml(person.zipCode)}`
      );

      memberMarkers.push(marker);
    }

    function addMeetingCenterMarkers() {
      if (!map) return;

      clearMarkers(meetingMarkers);

      for (const groupName in groupLocations) {
        const g = groupLocations[groupName];

        g.coordinates.forEach((coordRaw, idx) => {
          const coord = normalizeCoords(coordRaw);
          if (!coord) return;

          const marker = L.marker([coord.lat, coord.lon], {
            icon: L.divIcon({
              className: "meeting-center",
              html: `<div style="background:#d69e2e;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)">‚≠ê</div>`,
              iconSize: [30, 30]
            })
          }).addTo(map);

          marker.bindPopup(
            `<strong>${escapeHtml(groupName)}</strong><br>${escapeHtml(g.addresses[idx])}<br><em>Meeting Center</em>`
          );

          meetingMarkers.push(marker);
        });
      }
    }

    function fitMapToAllMarkers() {
      if (!map) return;

      const coords = [];

      allPeople.forEach((p) => {
        const c = normalizeCoords(p.coordinates);
        if (c) coords.push([c.lat, c.lon]);
      });

      for (const groupName in groupLocations) {
        groupLocations[groupName].coordinates.forEach((raw) => {
          const c = normalizeCoords(raw);
          if (c) coords.push([c.lat, c.lon]);
        });
      }

      if (coords.length === 0) return;
      const bounds = L.latLngBounds(coords);
      map.fitBounds(bounds, { padding: [40, 40] });
    }

    // -----------------------------
    // UI RENDER
    // -----------------------------
    function displayGroupAssignment(person) {
      document.getElementById("displayName").textContent = `${person.firstName} ${person.lastName}`;
      document.getElementById("displayPhone").textContent = formatPhone(person.phone) || "‚Äî";
      document.getElementById("displayLocation").textContent = person.location;
      document.getElementById("displayZip").textContent = person.zipCode;
      document.getElementById("displayGroup").textContent = person.group;

      const distText = (typeof person.distanceToGroup === "number")
        ? `${person.distanceToGroup.toFixed(1)} miles`
        : "N/A";

      const meetingHTML = `
        <div class="meeting-location">
          <h4><span>üìç</span> Meeting Location</h4>
          <p><strong>Address:</strong> ${escapeHtml(person.groupAddress ?? "")}</p>
          <p><strong>Meeting Time:</strong> First and Last Fridays at 8:00 PM</p>
          <p><strong>Distance:</strong> ${escapeHtml(distText)}</p>
        </div>
      `;
      document.getElementById("meetingLocationContainer").innerHTML = meetingHTML;

      const groupMembers = allPeople.filter((p) => p.group === person.group);

      const membersContainer = document.getElementById("membersContainer");
      if (groupMembers.length <= 1) {
        membersContainer.innerHTML = `<div class="member-item">You are the first member! üéâ</div>`;
      } else {
        membersContainer.innerHTML = groupMembers
          .map((m) =>
            `<div class="member-item">
              ${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)} - ${escapeHtml(m.zipCode)}
              ${m.phone ? `<br><small>üìû ${escapeHtml(formatPhone(m.phone))}</small>` : ""}
            </div>`
          )
          .join("");
      }

      const distBox = document.getElementById("distanceInfo");
      const me = normalizeCoords(person.coordinates);

      if (me && groupMembers.length > 1) {
        const others = groupMembers
          .filter((m) => m.timestamp !== person.timestamp)
          .map((m) => ({ ...m, coordinates: normalizeCoords(m.coordinates) }))
          .filter((m) => m.coordinates);

        if (others.length > 0) {
          const distances = others
            .map((m) => {
              const d = haversineMiles(me.lat, me.lon, m.coordinates.lat, m.coordinates.lon);
              return d === null ? null : { name: `${m.firstName} ${m.lastName}`, d };
            })
            .filter(Boolean);

          if (distances.length > 0) {
            const avg = distances.reduce((s, x) => s + x.d, 0) / distances.length;
            const closest = distances.reduce((min, x) => (x.d < min.d ? x : min));
            const farthest = distances.reduce((max, x) => (x.d > max.d ? x : max));

            distBox.style.display = "block";
            distBox.innerHTML =
              `<strong>üìç Distance to Group Members</strong><br>
               Average: ${avg.toFixed(1)} miles<br>
               Closest: ${escapeHtml(closest.name)} (${closest.d.toFixed(1)} mi)<br>
               Farthest: ${escapeHtml(farthest.name)} (${farthest.d.toFixed(1)} mi)`;
          } else {
            distBox.style.display = "none";
            distBox.innerHTML = "";
          }
        } else {
          distBox.style.display = "none";
          distBox.innerHTML = "";
        }
      } else {
        distBox.style.display = "none";
        distBox.innerHTML = "";
      }

      document.getElementById("groupDisplay").classList.add("show");
      document.getElementById("groupDisplay").scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    function displayAllGroups() {
      const groups = {};
      allPeople.forEach((p) => {
        if (!groups[p.group]) groups[p.group] = [];
        groups[p.group].push(p);
      });

      const groupsContainer = document.getElementById("groupsContainer");

      groupsContainer.innerHTML = Object.entries(groups)
        .sort((a, b) => b[1].length - a[1].length)
        .map(([groupName, members]) => {
          const zipCodes = [...new Set(members.map((m) => m.zipCode))].join(", ");
          return `
            <div class="group-card">
              <div class="group-card-header">
                <div class="group-title">‚úùÔ∏è ${escapeHtml(groupName)}</div>
                <div class="group-count">${members.length} ${members.length === 1 ? "member" : "members"}</div>
              </div>
              <div class="location-info"><strong>ZIP Codes:</strong> ${escapeHtml(zipCodes)}</div>
              <div class="group-members">
                ${members.map((m) => `
                  <div class="group-member">
                    ${escapeHtml(m.firstName)} ${escapeHtml(m.lastName)}<br>
                    <small>${escapeHtml(m.zipCode)}${m.phone ? " ‚Ä¢ üìû " + escapeHtml(formatPhone(m.phone)) : ""}</small>
                  </div>
                `).join("")}
              </div>
            </div>
          `;
        })
        .join("");

      document.getElementById("allGroups").style.display = allPeople.length > 0 ? "block" : "none";
      document.getElementById("exportSection").style.display = allPeople.length > 0 ? "block" : "none";
    }

    function refreshMapFromState() {
      if (allPeople.length === 0) return;

      document.getElementById("mapSection").style.display = "block";
      initMap();

      clearMarkers(memberMarkers);
      allPeople.forEach((p) => addMemberMarker(p));

      addMeetingCenterMarkers();
      fitMapToAllMarkers();
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // -----------------------------
    // EXPORTS
    // -----------------------------
    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function csvEscape(value) {
      const s = String(value ?? "");
      return `"${s.replaceAll('"', '""')}"`;
    }

    function exportToCSV() {
      if (allPeople.length === 0) return alert("No data to export.");

      let csv = "First Name,Last Name,Phone,Location,ZIP Code,Group,Group Address,Distance (miles)\n";
      allPeople.forEach((p) => {
        csv += [
          p.firstName, p.lastName, formatPhone(p.phone), p.location, p.zipCode, p.group, p.groupAddress,
          typeof p.distanceToGroup === "number" ? p.distanceToGroup.toFixed(1) : ""
        ].map(csvEscape).join(",") + "\n";
      });

      downloadFile(csv, "shelter_bible_study_groups.csv", "text/csv");
    }

    function exportToExcel() {
      if (allPeople.length === 0) return alert("No data to export.");

      const wsData = [
        ["First Name", "Last Name", "Phone", "Location", "ZIP Code", "Group", "Group Address", "Distance (miles)"]
      ];

      allPeople.forEach((p) => {
        wsData.push([
          p.firstName, p.lastName, formatPhone(p.phone), p.location, p.zipCode, p.group, p.groupAddress, p.distanceToGroup
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Group Assignments");
      XLSX.writeFile(wb, "shelter_bible_study_groups.xlsx");
    }

    function exportGroupSummary() {
      if (allPeople.length === 0) return alert("No data to export.");

      const groups = {};
      allPeople.forEach((p) => {
        if (!groups[p.group]) groups[p.group] = [];
        groups[p.group].push(p);
      });

      let csv = "Group Name,Member Count,ZIP Codes,Member Names\n";
      Object.entries(groups).forEach(([groupName, members]) => {
        const zipCodes = [...new Set(members.map((m) => m.zipCode))].join("; ");
        const names = members.map((m) => `${m.firstName} ${m.lastName}`).join("; ");
        csv += [groupName, members.length, zipCodes, names].map(csvEscape).join(",") + "\n";
      });

      downloadFile(csv, "group_summary_report.csv", "text/csv");
    }

    function exportWithDistances() {
      if (allPeople.length === 0) return alert("No data to export.");

      let csv = "First Name,Last Name,Phone,Group,ZIP Code,Avg Distance to Group (miles),Closest Member,Farthest Member\n";

      allPeople.forEach((person) => {
        let avgDist = "N/A";
        let closestMember = "N/A";
        let farthestMember = "N/A";

        const me = normalizeCoords(person.coordinates);
        if (me) {
          const groupMembers = allPeople
            .filter((p) => p.group === person.group && p.timestamp !== person.timestamp)
            .map((m) => ({ ...m, coordinates: normalizeCoords(m.coordinates) }))
            .filter((m) => m.coordinates);

          if (groupMembers.length > 0) {
            const distances = groupMembers
              .map((m) => {
                const d = haversineMiles(me.lat, me.lon, m.coordinates.lat, m.coordinates.lon);
                return d === null ? null : { name: `${m.firstName} ${m.lastName}`, d };
              })
              .filter(Boolean);

            if (distances.length > 0) {
              const avg = distances.reduce((s, x) => s + x.d, 0) / distances.length;
              const closest = distances.reduce((min, x) => (x.d < min.d ? x : min));
              const farthest = distances.reduce((max, x) => (x.d > max.d ? x : max));

              avgDist = avg.toFixed(1);
              closestMember = `${closest.name} (${closest.d.toFixed(1)} mi)`;
              farthestMember = `${farthest.name} (${farthest.d.toFixed(1)} mi)`;
            }
          }
        }

        csv += [
          person.firstName,
          person.lastName,
          formatPhone(person.phone),
          person.group,
          person.zipCode,
          avgDist,
          closestMember,
          farthestMember
        ].map(csvEscape).join(",") + "\n";
      });

      downloadFile(csv, "groups_with_distances.csv", "text/csv");
    }

    // -----------------------------
    // ADMIN DASHBOARD
    // -----------------------------
    function renderAdminTable() {
      const tbody = document.getElementById("adminTableBody");
      if (!tbody) return;

      const rows = [...allPeople]
        .sort((a, b) => (b.timestamp || "").localeCompare(a.timestamp || ""))
        .map((p) => {
          const name = `${p.firstName ?? ""} ${p.lastName ?? ""}`.trim();
          const phone = formatPhone(p.phone) || "";
          const zip = p.zipCode ?? "";
          const group = p.group ?? "";
          const groupAddress = p.groupAddress ?? "";
          const location = p.location ?? "";
          const distance = typeof p.distanceToGroup === "number" ? p.distanceToGroup.toFixed(1) : "";
          const ts = p.timestamp ? new Date(p.timestamp).toLocaleString() : "";

          return `
            <tr>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(name)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(phone)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(zip)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(group)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(groupAddress)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(location)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(distance)}</td>
              <td style="padding:10px; border-bottom:1px solid #e2e8f0;">${escapeHtml(ts)}</td>
            </tr>
          `;
        })
        .join("");

      tbody.innerHTML = rows || `<tr><td colspan="8" style="padding:12px;">No registrations yet.</td></tr>`;
    }

    function adminLogin() {
      const input = document.getElementById("adminPassword");
      const error = document.getElementById("adminLoginError");
      const loginBox = document.getElementById("adminLoginBox");
      const dash = document.getElementById("adminDashboard");

      if (!input || !error || !loginBox || !dash) return;

      if (input.value === ADMIN_PASSWORD) {
        error.style.display = "none";
        loginBox.style.display = "none";
        dash.style.display = "block";
        renderAdminTable();
      } else {
        error.style.display = "block";
      }
    }

    function adminLogout() {
      const input = document.getElementById("adminPassword");
      const loginBox = document.getElementById("adminLoginBox");
      const dash = document.getElementById("adminDashboard");
      const error = document.getElementById("adminLoginError");

      if (input) input.value = "";
      if (error) error.style.display = "none";
      if (loginBox) loginBox.style.display = "block";
      if (dash) dash.style.display = "none";
    }

    // -----------------------------
    // EVENTS
    // -----------------------------
    async function handleSubmit(event) {
      event.preventDefault();

      const firstName = document.getElementById("firstName").value.trim();
      const lastName = document.getElementById("lastName").value.trim();
      const phoneRaw = document.getElementById("phone").value.trim();
      const location = document.getElementById("location").value.trim();

      const phoneDigits = normalizePhone(phoneRaw);
      if (!phoneDigits) {
        alert("Please enter a valid 10-digit US phone number.");
        return;
      }

      const zipCode = extractILZipCode(location);
      if (!zipCode) {
        alert("Please enter a valid Illinois address with a ZIP code (60xxx format).");
        return;
      }

      document.getElementById("loadingSpinner").classList.add("show");
      document.getElementById("submitBtn").disabled = true;

      const coordinates = await geocodeAddress(location);

      document.getElementById("loadingSpinner").classList.remove("show");
      document.getElementById("submitBtn").disabled = false;

      if (!coordinates) {
        alert("Unable to geocode your address. Please check it and try again.");
        return;
      }

      const assignment = findNearestGroup(coordinates);

      const person = {
        firstName,
        lastName,
        phone: phoneDigits,     // ‚úÖ store digits consistently
        location,
        zipCode,
        coordinates,            // ‚úÖ normalized coords
        group: assignment.groupName,
        groupAddress: assignment.address,
        distanceToGroup: assignment.distance,
        timestamp: new Date().toISOString()
      };

      allPeople.push(person);
      save();
      showSuccess();

      displayGroupAssignment(person);
      displayAllGroups();

      document.getElementById("mapSection").style.display = "block";
      initMap();
      addMemberMarker(person);
      addMeetingCenterMarkers();
      fitMapToAllMarkers();

      // ‚úÖ If admin is open, refresh it
      if (document.getElementById("adminDashboard")?.style.display === "block") {
        renderAdminTable();
      }
    }

    function handleAddAnother() {
      document.getElementById("userForm").reset();
      document.getElementById("groupDisplay").classList.remove("show");
      document.getElementById("firstName").focus();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function handleReset() {
      if (!confirm("Are you sure you want to delete all saved members?")) return;

      allPeople = [];
      save();

      document.getElementById("groupDisplay").classList.remove("show");
      document.getElementById("mapSection").style.display = "none";
      document.getElementById("allGroups").style.display = "none";
      document.getElementById("exportSection").style.display = "none";
      document.getElementById("groupsContainer").innerHTML = "";

      if (map) {
        clearMarkers(memberMarkers);
        clearMarkers(meetingMarkers);
      }

      // reset admin view if open
      adminLogout();

      alert("All data cleared.");
    }

    // -----------------------------
    // INIT
    // -----------------------------
    document.addEventListener("DOMContentLoaded", () => {
      load();

      document.getElementById("adminLoginBtn")?.addEventListener("click", adminLogin);
      document.getElementById("adminRefreshBtn")?.addEventListener("click", renderAdminTable);
      document.getElementById("adminLogoutBtn")?.addEventListener("click", adminLogout);

      document.getElementById("userForm").addEventListener("submit", handleSubmit);
      document.getElementById("addAnotherBtn").addEventListener("click", handleAddAnother);
      document.getElementById("resetBtn").addEventListener("click", handleReset);

      document.getElementById("exportCsvBtn").addEventListener("click", exportToCSV);
      document.getElementById("exportXlsxBtn").addEventListener("click", exportToExcel);
      document.getElementById("exportSummaryBtn").addEventListener("click", exportGroupSummary);
      document.getElementById("exportDistancesBtn").addEventListener("click", exportWithDistances);

      if (allPeople.length > 0) {
        displayAllGroups();
        refreshMapFromState();
      }
    });
  </script>
</body>
</html>

